{% extends "base.html" %}

{% block title %}ë¼ë²¨ë§ í¸ì§‘ - YOKOGAWA OCR System{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="/static/css/label-suggestions.css?v={{ range(1, 10000) | random }}">
<link rel="stylesheet" href="/static/css/training-progress.css?v={{ range(1, 10000) | random }}">
<style>
    /* ë¼ë²¨ë§ í¸ì§‘ ì „ìš© ìŠ¤íƒ€ì¼ */
    .labeling-editor {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .labeling-main-layout {
        display: grid;
        grid-template-columns: var(--left-panel-width, 250px) 1fr var(--right-panel-width, 350px);
        gap: 20px;
        margin-top: 20px;
        height: calc(100vh - 180px);
        /* ê° ì˜ì—­ì´ ë…ë¦½ì ìœ¼ë¡œ ìŠ¤í¬ë¡¤ë˜ë„ë¡ ì„¤ì • */
        position: relative;
    }
    
    /* ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ */
    @media (max-width: 1400px) {
        .labeling-main-layout {
            grid-template-columns: var(--left-panel-width, 200px) 1fr var(--right-panel-width, 300px);
        }
    }
    
    @media (max-width: 1200px) {
        .labeling-main-layout {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .labeling-controls-section,
        .labeling-form-section {
            max-width: 100%;
            margin-bottom: 20px;
        }
    }

    /* ì™¼ìª½ ì»¨íŠ¸ë¡¤ ì„¹ì…˜ */
    .labeling-controls-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        /* ë…ë¦½ì ì¸ ìŠ¤í¬ë¡¤ ì˜ì—­ */
        overflow-y: auto;
        overflow-x: hidden;
        height: calc(100vh - 200px);
        position: sticky;
        top: 20px;
    }

    .labeling-controls-section h3 {
        font-size: 16px;
        margin-bottom: 10px;
        color: var(--text-color);
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }

    .labeling-controls-section button {
        width: 100%;
        margin-bottom: 8px;
        justify-content: flex-start;
    }

    /* ì¤‘ì•™ ì´ë¯¸ì§€ ì„¹ì…˜ */
    .labeling-image-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        /* ë…ë¦½ì ì¸ ìŠ¤í¬ë¡¤ ì˜ì—­ */
        height: calc(100vh - 200px);
        overflow: hidden;
    }

    .pdf-navigation {
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
    }

    .page-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
    }

    .page-info {
        font-weight: 500;
        min-width: 80px;
        text-align: center;
    }

    .image-preview {
        position: relative;
        flex: 1;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        /* ì´ë¯¸ì§€ ì˜ì—­ë§Œ ìŠ¤í¬ë¡¤ */
        overflow: auto;
        max-height: calc(100vh - 350px);
    }

    .image-container {
        position: relative;
        display: inline-block;
        min-width: 100%;
    }
    
    #bboxOverlays {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    
    #bboxOverlays .bbox-overlay {
        pointer-events: all;
    }

    #labelingImage {
        width: auto;
        height: auto;
        max-width: none;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: block;
    }

    /* Bounding box ì˜¤ë²„ë ˆì´ */
    .bbox-overlay {
        position: absolute;
        border: 2px solid #ff0000;
        background-color: rgba(255, 0, 0, 0.1);
        cursor: move;
        z-index: 100;
    }

    .bbox-overlay.selected {
        border-color: #0066ff;
        background-color: rgba(0, 102, 255, 0.2);
        z-index: 101;
    }

    .bbox-overlay .resize-handle {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #fff;
        border: 2px solid #ff0000;
        border-radius: 50%;
    }

    .bbox-overlay.selected .resize-handle {
        border-color: #0066ff;
    }

    .bbox-overlay .resize-handle.nw { top: -4px; left: -4px; cursor: nw-resize; }
    .bbox-overlay .resize-handle.ne { top: -4px; right: -4px; cursor: ne-resize; }
    .bbox-overlay .resize-handle.sw { bottom: -4px; left: -4px; cursor: sw-resize; }
    .bbox-overlay .resize-handle.se { bottom: -4px; right: -4px; cursor: se-resize; }

    .bbox-label {
        position: absolute;
        top: -20px;
        left: 0;
        background: #ff0000;
        color: white;
        padding: 2px 6px;
        font-size: 11px;
        border-radius: 3px;
        white-space: nowrap;
    }

    .bbox-overlay.selected .bbox-label {
        background: #0066ff;
    }

    /* ê·¸ë£¹ë³„ ìƒ‰ìƒ */
    .bbox-overlay.group-1 { border-color: #4CAF50; background-color: rgba(76, 175, 80, 0.1); }
    .bbox-overlay.group-2 { border-color: #2196F3; background-color: rgba(33, 150, 243, 0.1); }
    .bbox-overlay.group-3 { border-color: #FF9800; background-color: rgba(255, 152, 0, 0.1); }
    .bbox-overlay.group-4 { border-color: #9C27B0; background-color: rgba(156, 39, 176, 0.1); }
    .bbox-overlay.group-5 { border-color: #795548; background-color: rgba(121, 85, 72, 0.1); }

    /* ì˜¤ë¥¸ìª½ ë¼ë²¨ ì •ë³´ ì„¹ì…˜ */
    .labeling-form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        /* ë…ë¦½ì ì¸ ìŠ¤í¬ë¡¤ ì˜ì—­ */
        overflow-y: auto;
        overflow-x: hidden;
        height: calc(100vh - 200px);
        position: sticky;
        top: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--text-color);
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    /* ë¹ ë¥¸ ë¼ë²¨ ë²„íŠ¼ */
    .label-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 10px;
    }

    .btn-label {
        background: #e9ecef;
        border: 1px solid #ddd;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
        text-align: left;
    }

    .btn-label:hover {
        background: #dee2e6;
        transform: translateY(-1px);
    }

    /* Bounding Box ëª©ë¡ */
    #bboxList {
        margin-top: 10px;
        min-height: 200px;
        /* ë¶€ëª¨ ì˜ì—­ì—ì„œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ */
        overflow: visible;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 10px;
        background: #fafafa;
    }

    .bbox-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .bbox-item:hover {
        background: #f8f9fa;
        border-color: var(--primary-color);
    }

    .bbox-item.selected {
        background: #e3f2fd;
        border-color: #0066ff;
    }

    .bbox-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }

    .bbox-item-title {
        font-weight: 500;
        font-size: 14px;
    }

    .bbox-item-actions {
        display: flex;
        gap: 5px;
    }
    
    .bbox-item-actions button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 3px;
        transition: background 0.2s;
    }
    
    .bbox-item-actions button:hover {
        background: rgba(0,0,0,0.1);
    }
    
    .bbox-item-actions .delete-btn {
        color: #dc3545;
    }
    
    .bbox-item-actions .group-btn {
        color: #007bff;
    }

    .bbox-item-content {
        font-size: 14px;
        color: #666;
    }
    
    /* Bounding box ëª©ë¡ì˜ input í•„ë“œ í°íŠ¸ í¬ê¸° */
    .bbox-item input[type="text"],
    .bbox-item textarea,
    .bbox-item select {
        font-size: 14px;
        min-height: 28px;
    }
    
    /* ë¼ë²¨ ì •ë³´ë€ì˜ ëª¨ë“  í…ìŠ¤íŠ¸ í¬ê¸° ì¦ê°€ */
    .labeling-form-section input,
    .labeling-form-section select,
    .labeling-form-section textarea {
        font-size: 16px;
    }
    
    .labeling-form-section label {
        font-size: 14px;
        font-weight: 500;
    }

    .bbox-item-row {
        display: flex;
        justify-content: space-between;
        margin-top: 2px;
    }

    /* ê·¸ë£¹ ê´€ë¦¬ íŒ¨ë„ */
    #groupManagementPanel {
        background: white;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-top: 15px;
    }

    #groupManagementPanel h4 {
        font-size: 14px;
        margin-bottom: 10px;
    }

    .form-control {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }

    /* íˆ´ë°” ìŠ¤íƒ€ì¼ */
    .bbox-list-toolbar {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .bbox-list-toolbar .btn {
        font-size: 12px;
        padding: 4px 8px;
    }
    
    /* ë²„íŠ¼ ìƒíƒœ */
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-info:hover {
        background: #138496;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    /* ë“œë¡œì‰ ëª¨ë“œ */
    .drawing-mode .image-container {
        cursor: crosshair;
    }

    .drawing-box {
        position: absolute;
        border: 2px dashed #ff0000;
        background-color: rgba(255, 0, 0, 0.1);
        pointer-events: none;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 1400px) {
        .labeling-main-layout {
            grid-template-columns: 200px 1fr 300px;
        }
    }

    @media (max-width: 1200px) {
        .labeling-main-layout {
            grid-template-columns: 1fr;
            height: auto;
        }

        .labeling-controls-section,
        .labeling-form-section {
            /* ëª¨ë°”ì¼ì—ì„œëŠ” ë†’ì´ ì œí•œ */
            height: auto;
            max-height: 500px;
            position: relative;
        }
    }
    
    /* ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .spinner-border {
        display: inline-block;
        width: 3rem;
        height: 3rem;
        border: 0.25em solid #007bff;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spin 0.75s linear infinite;
    }
    
    /* ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ ì¶”ì²œ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
    .smart-label-overlay {
        position: absolute;
        background: rgba(33, 150, 243, 0.2);
        border: 2px dashed #2196F3;
        pointer-events: none;
        z-index: 100;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .smart-label-suggestion {
        background: rgba(255, 255, 255, 0.98);
        /* í™”ë©´ ë°°ìœ¨ì— ë”°ë¼ í¬ê¸° ì¡°ì • */
        padding: calc(8px / var(--zoom-scale, 1)) calc(12px / var(--zoom-scale, 1));
        border-radius: calc(6px / var(--zoom-scale, 1));
        font-size: calc(14px / var(--zoom-scale, 1));
        font-weight: 500;
        color: #1976D2;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        border: calc(1px / var(--zoom-scale, 1)) solid #2196F3;
        /* ìµœì†Œ í¬ê¸° ë³´ì¥ */
        min-width: calc(150px / var(--zoom-scale, 1));
        min-height: calc(40px / var(--zoom-scale, 1));
        line-height: 1.4;
    }
    
    .smart-label-confidence {
        display: inline-block;
        margin-left: calc(8px / var(--zoom-scale, 1));
        padding: calc(3px / var(--zoom-scale, 1)) calc(8px / var(--zoom-scale, 1));
        background: #E3F2FD;
        border-radius: calc(12px / var(--zoom-scale, 1));
        font-size: calc(13px / var(--zoom-scale, 1));
        color: #0D47A1;
        font-weight: bold;
    }
    
    .smart-label-accept-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 24px;
        height: 24px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        pointer-events: auto;
        transition: transform 0.2s;
        z-index: 101;
    }
    
    .smart-label-accept-btn:hover {
        transform: scale(1.2);
        background: #45a049;
    }
    
    .smart-label-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f0f4f8;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    
    .smart-label-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .smart-label-toggle label {
        cursor: pointer;
        font-weight: 500;
        color: #333;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .smart-label-status {
        display: inline-block;
        padding: 3px 8px;
        background: #E8F5E9;
        color: #2E7D32;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
    }
    
    .smart-label-status.inactive {
        background: #FFEBEE;
        color: #C62828;
    }
</style>
{% endblock %}

{% block content %}
<div class="labeling-editor">
    <h2>ë¼ë²¨ë§ ë°ì´í„° í¸ì§‘</h2>
    
    <div id="labelingContent" style="margin-top: 20px;">
        <p>ë¼ë²¨ë§ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        <button class="btn btn-primary" onclick="loadLabelingData()">
            <span>ğŸ“‚</span> ë¼ë²¨ë§ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
    </div>
    
    <!-- ë¼ë²¨ë§ í¸ì§‘ ì¸í„°í˜ì´ìŠ¤ -->
    <div id="labelingInterface" style="display: none;">
        <div class="labeling-main-layout">
            <!-- ì™¼ìª½: ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì„¹ì…˜ -->
            <div class="labeling-controls-section">
                <h3>ë°ì´í„° ê´€ë¦¬</h3>
                <button class="btn btn-primary" onclick="loadLabelingData()">
                    <span>ğŸ“‚</span> ë¼ë²¨ë§ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <button class="btn btn-success" onclick="saveLabelingData()">
                    <span>ğŸ’¾</span> ë³€ê²½ì‚¬í•­ ì €ì¥
                </button>
                <button class="btn btn-success" onclick="saveCurrentLabelData()" id="saveCurrentBtn" style="display: none;">
                    <span>ğŸ’¾</span> í˜„ì¬ ë¼ë²¨ ì €ì¥
                </button>
                
                <h3 style="margin-top: 20px;">ëª¨ë¸ ê´€ë¦¬</h3>
                <button class="btn btn-primary" onclick="trainModel()">
                    <span>ğŸ¯</span> ëª¨ë¸ í•™ìŠµ
                </button>
                <button class="btn btn-info" onclick="showModelStats()">
                    <span>ğŸ“Š</span> ëª¨ë¸ í†µê³„
                </button>
                <button class="btn btn-warning" onclick="labelingSystem.showOCRLearningStatus()">
                    <span>ğŸ“ˆ</span> OCR í•™ìŠµ ìƒíƒœ
                </button>
                <button class="btn btn-danger" onclick="resetModel()">
                    <span>ğŸ”„</span> ëª¨ë¸ ì´ˆê¸°í™”
                </button>
                <button class="btn btn-success" onclick="labelingSystem.getAutoLabels()" id="autoLabelBtn">
                    <span>ğŸ¤–</span> ìë™ ë¼ë²¨ ì œì•ˆ
                </button>
                
                <!-- ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ í† ê¸€ -->
                <h3 style="margin-top: 20px;">ìŠ¤ë§ˆíŠ¸ ë¼ë²¨</h3>
                <div class="smart-label-toggle">
                    <input type="checkbox" id="smartLabelToggle" checked onchange="toggleSmartLabels()">
                    <label for="smartLabelToggle">
                        <span>ğŸ’¡</span> AI ë¼ë²¨ ì¶”ì²œ í™œì„±í™”
                    </label>
                    <span class="smart-label-status" id="smartLabelStatus">í™œì„±</span>
                </div>
                <button class="btn btn-info" onclick="refreshSmartLabels()">
                    <span>ğŸ”„</span> ì¶”ì²œ ìƒˆë¡œê³ ì¹¨
                </button>
                
                <h3 style="margin-top: 20px;">í¸ì§‘ ë„êµ¬</h3>
                <button class="btn btn-primary" onclick="startDrawing()" id="drawBtn">
                    <span>âœï¸</span> Bounding Box ê·¸ë¦¬ê¸°
                </button>
                <button class="btn btn-warning" onclick="clearSelection()">
                    <span>ğŸ—ï¸</span> ì„ íƒ í•´ì œ
                </button>
                <button class="btn btn-warning" onclick="deleteSelectedBox()">
                    <span>ğŸ—‘ï¸</span> ì„ íƒí•œ Box ì‚­ì œ
                </button>
                <button class="btn btn-primary" onclick="addBoundingBox()">
                    <span>â•</span> ìƒˆ Bounding Box ì¶”ê°€
                </button>
                <button class="btn btn-danger" onclick="clearAllLabels()">
                    <span>ğŸ—‘ï¸</span> ëª¨ë“  ë¼ë²¨ ì´ˆê¸°í™”
                </button>
                
                <h3 style="margin-top: 20px;">ê·¸ë£¹ ê´€ë¦¬</h3>
                <button class="btn btn-info" onclick="toggleGroupMode()" id="groupModeBtn">
                    <span>ğŸ”—</span> ê·¸ë£¹ ëª¨ë“œ OFF
                </button>
                <button class="btn btn-success" onclick="autoGroupByRows()">
                    <span>ğŸ¯</span> ìë™ í–‰ ê·¸ë£¹í•‘
                </button>
                <button class="btn btn-primary" onclick="highlightGroups()">
                    <span>ğŸ¨</span> ê·¸ë£¹ í•˜ì´ë¼ì´íŠ¸
                </button>
                
                <!-- ê·¸ë£¹ ì„ íƒ ë° ê´€ë¦¬ UI -->
                <div id="groupManagementPanel" style="display: none;">
                    <h4>ê·¸ë£¹ ê´€ë¦¬ íŒ¨ë„</h4>
                    <div style="margin-bottom: 10px;">
                        <label>í˜„ì¬ ê·¸ë£¹:</label>
                        <select id="currentGroupSelect" class="form-control" onchange="selectGroup(this.value)">
                            <option value="">ê·¸ë£¹ ì„ íƒ...</option>
                        </select>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="createNewGroup()">
                        <span>â•</span> ìƒˆ ê·¸ë£¹ ìƒì„±
                    </button>
                    <button class="btn btn-sm btn-success" onclick="addToCurrentGroup()" id="addToGroupBtn" disabled>
                        <span>ğŸ“</span> ì„ íƒëœ í•­ëª©ì„ ê·¸ë£¹ì— ì¶”ê°€
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="removeFromGroup()">
                        <span>â–</span> ê·¸ë£¹ì—ì„œ ì œê±°
                    </button>
                </div>
            </div>
            
            <!-- ì¤‘ì•™: ì´ë¯¸ì§€ ì„¹ì…˜ -->
            <div class="labeling-image-section">
                <h3>ë¬¸ì„œ ì´ë¯¸ì§€</h3>
                
                <!-- PDF í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="pdf-navigation" id="pdfNavigation" style="display: none;">
                    <div class="page-controls">
                        <button class="btn btn-primary" onclick="previousPage()" id="prevPageBtn">
                            <span>â—€</span> ì´ì „ í˜ì´ì§€
                        </button>
                        <span class="page-info" id="pageInfo">1 / 1</span>
                        <button class="btn btn-primary" onclick="nextPage()" id="nextPageBtn">
                            ë‹¤ìŒ í˜ì´ì§€ <span>â–¶</span>
                        </button>
                    </div>
                </div>
                
                <div class="image-preview">
                    <div class="image-container" id="imageContainer">
                        <img id="labelingImage" src="" alt="ë¬¸ì„œ ì´ë¯¸ì§€" style="display: none;">
                        <div id="bboxOverlays"></div>
                    </div>
                </div>
            </div>
            
            <!-- ì˜¤ë¥¸ìª½: ë¼ë²¨ ì •ë³´ ì„¹ì…˜ -->
            <div class="labeling-form-section">
                <h3>ë¼ë²¨ ì •ë³´</h3>
                <div class="form-group">
                    <label for="labelingFilename">íŒŒì¼ëª…</label>
                    <input type="text" id="labelingFilename" name="labelingFilename" readonly>
                </div>
                <div class="form-group">
                    <label for="documentClass">ë¬¸ì„œ í´ë˜ìŠ¤</label>
                    <select id="documentClass" name="documentClass">
                        <option value="purchase_order">Purchase Order</option>
                        <option value="invoice">Invoice</option>
                        <option value="receipt">Receipt</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <h4 style="margin-top: 20px;">ë¹ ë¥¸ ë¼ë²¨ ì„ íƒ</h4>
                <div class="label-buttons">
                    <button class="btn-label" onclick="setQuickLabel('Order number')">
                        ğŸ“‹ Order number
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('Shipping line')">
                        ğŸš¢ Shipping line
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('Case mark')">
                        ğŸ“¦ Case mark
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('Item number')">
                        ğŸ”¢ Item number
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('Part number')">
                        ğŸ”§ Part number
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('Delivery date')">
                        ğŸ“… Delivery date
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('Quantity')">
                        ğŸ“Š Quantity
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('Unit price')">
                        ğŸ’² Unit price
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('Net amount (total)')">
                        ğŸ’° Net amount (total)
                    </button>
                    <button class="btn-label" onclick="setQuickLabel('WUKERAN')">
                        ğŸ·ï¸ WUKERAN
                    </button>
                </div>
                
                <h4 style="margin-top: 20px;">Bounding Box ëª©ë¡</h4>
                <div class="bbox-list-toolbar" style="margin-bottom: 10px;">
                    <button class="btn btn-sm btn-primary" onclick="addNewGroup()">
                        <i class="fas fa-plus"></i> ìƒˆ ê·¸ë£¹ ì¶”ê°€
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="autoGroupByRow()">
                        <i class="fas fa-magic"></i> ìë™ ê·¸ë£¹í™”
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="clearAllGroups()">
                        <i class="fas fa-unlink"></i> ê·¸ë£¹ ì´ˆê¸°í™”
                    </button>
                    <button class="btn btn-sm btn-success" onclick="saveAndRefreshBboxList()">
                        <i class="fas fa-save"></i> ì €ì¥
                    </button>
                </div>
                <div id="bboxList">
                    <p>ê·¸ë ¤ì§„ Bounding Boxê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
                
                <h4 style="margin-top: 20px;">OCR ë°ì´í„° ê²°ê³¼ ëª©ë¡</h4>
                <div class="ocr-list-toolbar" style="margin-bottom: 10px;">
                    <button class="btn btn-sm btn-primary" onclick="labelingSystem.executeOCROnAll()">
                        <i class="fas fa-sync"></i> ì „ì²´ OCR ì‹¤í–‰
                    </button>
                    <button class="btn btn-sm btn-info" onclick="labelingSystem.applyOCRToBbox()">
                        <i class="fas fa-copy"></i> OCR ê²°ê³¼ ì ìš©
                    </button>
                </div>
                <div id="ocrResultList" style="margin-top: 10px; min-height: 200px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; background: #f0f8ff; position: relative;">
                    <div id="ocrProcessingSpinner" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(240, 248, 255, 0.9); z-index: 1000; justify-content: center; align-items: center;">
                        <div style="text-align: center;">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="sr-only">ì²˜ë¦¬ ì¤‘...</span>
                            </div>
                            <div style="margin-top: 10px; font-weight: bold; color: #007bff;">OCR ì²˜ë¦¬ ì¤‘...</div>
                        </div>
                    </div>
                    <div id="ocrResultContent">
                        <p>OCR ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ëª¨ë¸ í•™ìŠµ ì§„í–‰ë¥  ëª¨ë‹¬ -->
<div id="trainingProgressModal" class="training-progress-modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeTrainingProgress()"></div>
    <div class="modal-content">
        <h3>ğŸ¯ ëª¨ë¸ í•™ìŠµ ì§„í–‰ ì¤‘...</h3>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="trainingProgressBar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="trainingProgressText">0%</div>
        </div>
        <div class="progress-message" id="trainingProgressMessage">í•™ìŠµ ë°ì´í„° ì¤€ë¹„ ì¤‘...</div>
        <div class="progress-details" id="trainingProgressDetails"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/labeling.js?v={{ range(1, 10000) | random }}"></script>
<script>
// í™”ë©´ ë°°ìœ¨ì— ë”°ë¥¸ íŒ¨ë„ í¬ê¸° ë° ê¸€ì”¨ í¬ê¸° ì¡°ì •
function adjustPanelSizeByZoom() {
    // ë¸Œë¼ìš°ì € ë°°ìœ¨ ê°ì§€ (ë” ì •í™•í•œ ë°©ë²•)
    const zoomLevel = Math.round(window.devicePixelRatio * 100) / 100;
    
    // CSS ë³€ìˆ˜ë¡œ zoom scale ì„¤ì • (ì¶”ì²œ ë¼ë²¨ ë°•ìŠ¤ í¬ê¸° ì¡°ì •ìš©)
    document.documentElement.style.setProperty('--zoom-scale', zoomLevel);
    
    // ê¸°ë³¸ í¬ê¸°
    const baseLeftWidth = 250;
    const baseRightWidth = 350;
    
    // ë°°ìœ¨ì— ë°˜ë¹„ë¡€í•˜ëŠ” í¬ê¸° ê³„ì‚°
    // 25% ë°°ìœ¨ (0.25) -> í¬ê¸° ì¦ê°€
    // 100% ë°°ìœ¨ (1.0) -> ê¸°ë³¸ í¬ê¸°
    const scaleFactor = 1 / zoomLevel;
    const leftWidth = Math.round(baseLeftWidth * scaleFactor);
    const rightWidth = Math.round(baseRightWidth * scaleFactor);
    
    // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ
    const minWidth = 180;
    const maxWidth = 500;
    
    const finalLeftWidth = Math.max(minWidth, Math.min(maxWidth, leftWidth));
    const finalRightWidth = Math.max(minWidth + 50, Math.min(maxWidth + 100, rightWidth));
    
    // CSS ë³€ìˆ˜ ì„¤ì •
    document.documentElement.style.setProperty('--left-panel-width', `${finalLeftWidth}px`);
    document.documentElement.style.setProperty('--right-panel-width', `${finalRightWidth}px`);
    
    // ê¸€ì”¨ í¬ê¸° ì¡°ì •
    // 25% ë°°ìœ¨ì—ì„œë„ ì½ê¸° ì‰½ë„ë¡ ê¸€ì”¨ í¬ê¸°ë¥¼ ë°°ìœ¨ì— ë°˜ë¹„ë¡€í•˜ì—¬ ì¡°ì •
    // ê¸°ë³¸ í°íŠ¸ í¬ê¸°
    const baseFontSize = 14;
    const baseSmallFontSize = 12;
    const baseLabelFontSize = 16;
    
    // ë°°ìœ¨ì´ ë‚®ì„ìˆ˜ë¡ ê¸€ì”¨ë¥¼ í¬ê²Œ (ìµœëŒ€ 2ë°°ê¹Œì§€)
    const fontScaleFactor = Math.min(2, Math.max(1, 1 / zoomLevel));
    
    // ì¢Œì¸¡ íŒ¨ë„ ê¸€ì”¨ í¬ê¸°
    const leftPanelFontSize = Math.round(baseFontSize * fontScaleFactor);
    const leftPanelButtonFontSize = Math.round(baseSmallFontSize * fontScaleFactor);
    
    // ìš°ì¸¡ íŒ¨ë„ ê¸€ì”¨ í¬ê¸°
    const rightPanelFontSize = Math.round(baseLabelFontSize * fontScaleFactor);
    const rightPanelInputFontSize = Math.round(baseFontSize * fontScaleFactor);
    
    // ìŠ¤íƒ€ì¼ ì ìš©
    const style = document.createElement('style');
    style.id = 'zoom-adjusted-styles';
    style.innerHTML = `
        /* ì¢Œì¸¡ íŒ¨ë„ ê¸€ì”¨ í¬ê¸° */
        .labeling-controls-section {
            font-size: ${leftPanelFontSize}px !important;
        }
        .labeling-controls-section h3 {
            font-size: ${leftPanelFontSize + 2}px !important;
        }
        .labeling-controls-section button {
            font-size: ${leftPanelButtonFontSize}px !important;
        }
        
        /* ìš°ì¸¡ íŒ¨ë„ ê¸€ì”¨ í¬ê¸° */
        .labeling-form-section {
            font-size: ${rightPanelFontSize}px !important;
        }
        .labeling-form-section h3,
        .labeling-form-section h4 {
            font-size: ${rightPanelFontSize + 2}px !important;
        }
        .labeling-form-section label {
            font-size: ${rightPanelFontSize}px !important;
        }
        .labeling-form-section input,
        .labeling-form-section select,
        .labeling-form-section textarea {
            font-size: ${rightPanelInputFontSize}px !important;
        }
        
        /* Bounding Box ëª©ë¡ ê¸€ì”¨ í¬ê¸° */
        .bbox-item {
            font-size: ${rightPanelFontSize}px !important;
        }
        .bbox-item input,
        .bbox-item textarea,
        .bbox-item select {
            font-size: ${rightPanelInputFontSize}px !important;
        }
        .bbox-item-title {
            font-size: ${rightPanelFontSize}px !important;
        }
        
        /* ë¹ ë¥¸ ë¼ë²¨ ë²„íŠ¼ */
        .btn-label {
            font-size: ${leftPanelButtonFontSize}px !important;
        }
        
        /* íˆ´ë°” ë²„íŠ¼ */
        .bbox-list-toolbar .btn,
        .ocr-list-toolbar .btn {
            font-size: ${leftPanelButtonFontSize}px !important;
        }
    `;
    
    // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
    const existingStyle = document.getElementById('zoom-adjusted-styles');
    if (existingStyle) {
        existingStyle.remove();
    }
    document.head.appendChild(style);
    
    console.log(`Zoom: ${zoomLevel * 100}%, Font Scale: ${fontScaleFactor}x`);
    console.log(`Left Panel: ${finalLeftWidth}px, Font: ${leftPanelFontSize}px`);
    console.log(`Right Panel: ${finalRightWidth}px, Font: ${rightPanelFontSize}px`);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    // í™”ë©´ ë°°ìœ¨ ì¡°ì •
    adjustPanelSizeByZoom();
    
    // í™”ë©´ í¬ê¸° ë³€ê²½ ê°ì§€
    window.addEventListener('resize', adjustPanelSizeByZoom);
    
    // ë°°ìœ¨ ë³€ê²½ ê°ì§€ë¥¼ ìœ„í•œ ì¶”ê°€ ëª¨ë‹ˆí„°ë§
    let lastDevicePixelRatio = window.devicePixelRatio;
    
    // 100msë§ˆë‹¤ ë°°ìœ¨ ë³€ê²½ ì²´í¬
    setInterval(() => {
        if (window.devicePixelRatio !== lastDevicePixelRatio) {
            lastDevicePixelRatio = window.devicePixelRatio;
            adjustPanelSizeByZoom();
        }
    }, 100);
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ íŒŒì¼ëª… ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const filename = urlParams.get('file');
    
    if (filename) {
        // íŒŒì¼ì´ ì§€ì •ëœ ê²½ìš° ìë™ìœ¼ë¡œ ë¡œë“œ
        loadSpecificFile(filename);
    }
});

// íŠ¹ì • íŒŒì¼ ë¡œë“œ
async function loadSpecificFile(filename) {
    try {
        showLoading('labelingContent');
        
        // ë¼ë²¨ë§ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
        document.getElementById('labelingContent').style.display = 'none';
        document.getElementById('labelingInterface').style.display = 'block';
        document.getElementById('saveCurrentBtn').style.display = 'inline-flex';
        
        // labeling.jsì˜ í•¨ìˆ˜ í˜¸ì¶œ
        if (window.loadLabelingDataForFile) {
            await window.loadLabelingDataForFile(filename);
        } else {
            console.error('loadLabelingDataForFile function not found');
        }
        
        hideLoading('labelingContent');
        showAlert('íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
        
    } catch (error) {
        hideLoading('labelingContent');
        console.error('Failed to load file:', error);
        showAlert(`íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
    }
}

// ì¤‘ë³µëœ í•¨ìˆ˜ ì œê±° - labeling.jsì— ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆìŒ

// ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ ê¸°ëŠ¥
let smartLabelsEnabled = true;
let smartLabelPredictions = [];

// ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ í† ê¸€
function toggleSmartLabels() {
    const toggle = document.getElementById('smartLabelToggle');
    const status = document.getElementById('smartLabelStatus');
    smartLabelsEnabled = toggle.checked;
    
    status.textContent = smartLabelsEnabled ? 'í™œì„±' : 'ë¹„í™œì„±';
    status.className = smartLabelsEnabled ? 'smart-label-status' : 'smart-label-status inactive';
    
    if (smartLabelsEnabled) {
        refreshSmartLabels();
    } else {
        clearSmartLabelOverlays();
    }
}

// ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ ìƒˆë¡œê³ ì¹¨
async function refreshSmartLabels() {
    if (!smartLabelsEnabled) return;
    
    const image = document.getElementById('labelingImage');
    if (!image || !image.src) {
        showAlert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    try {
        showLoading('bboxOverlays');
        
        // í˜„ì¬ íŒŒì¼ëª…ê³¼ ë¬¸ì„œ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
        const filename = document.getElementById('labelingFilename').value;
        const documentType = document.getElementById('documentClass').value;
        
        // API í˜¸ì¶œí•˜ì—¬ ì˜ˆì¸¡ ë°›ê¸°
        const response = await fetch('/api/predict_smart_labels', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                filename: filename,
                document_type: documentType
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to get smart label predictions');
        }
        
        const data = await response.json();
        smartLabelPredictions = data.predictions || [];
        
        // ì˜¤ë²„ë ˆì´ í‘œì‹œ
        displaySmartLabelOverlays();
        
        hideLoading('bboxOverlays');
        
        if (smartLabelPredictions.length > 0) {
            showAlert(`${smartLabelPredictions.length}ê°œì˜ ë¼ë²¨ ì¶”ì²œì„ ë°›ì•˜ìŠµë‹ˆë‹¤.`, 'success');
        } else {
            showAlert('ì¶”ì²œí•  ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
        }
        
    } catch (error) {
        hideLoading('bboxOverlays');
        console.error('Failed to refresh smart labels:', error);
        showAlert('ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ ì¶”ì²œì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ ì˜¤ë²„ë ˆì´ í‘œì‹œ
function displaySmartLabelOverlays() {
    clearSmartLabelOverlays();
    
    const overlaysContainer = document.getElementById('bboxOverlays');
    const image = document.getElementById('labelingImage');
    
    if (!overlaysContainer || !image) return;
    
    const imageRect = image.getBoundingClientRect();
    const containerRect = overlaysContainer.getBoundingClientRect();
    
    smartLabelPredictions.forEach((prediction, index) => {
        // ì´ë¯¸ì§€ ì¢Œí‘œë¥¼ í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜
        const scaleX = image.naturalWidth / image.width;
        const scaleY = image.naturalHeight / image.height;
        
        const x = prediction.x / scaleX;
        const y = prediction.y / scaleY;
        const width = prediction.width / scaleX;
        const height = prediction.height / scaleY;
        
        // ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.createElement('div');
        overlay.className = 'smart-label-overlay';
        overlay.id = `smart-label-${index}`;
        overlay.style.left = `${x}px`;
        overlay.style.top = `${y}px`;
        overlay.style.width = `${width}px`;
        overlay.style.height = `${height}px`;
        
        // ë¼ë²¨ ì •ë³´ í‘œì‹œ
        const suggestion = document.createElement('div');
        suggestion.className = 'smart-label-suggestion';
        
        // ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ì²˜ë¦¬ (ë„ˆë¬´ ê¸¸ë©´ ì¤„ì„)
        const extractedText = prediction.predicted_text || prediction.text || '';
        const displayText = extractedText.length > 30 ? 
            extractedText.substring(0, 30) + '...' : extractedText;
        
        suggestion.innerHTML = `
            <div style="font-weight: bold; margin-bottom: calc(4px / var(--zoom-scale, 1));">
                ${prediction.label_type}
                <span class="smart-label-confidence">${Math.round(prediction.confidence * 100)}%</span>
            </div>
            <div style="font-size: calc(12px / var(--zoom-scale, 1)); color: #666; margin-top: calc(4px / var(--zoom-scale, 1));">
                ${displayText ? `"${displayText}"` : '(í…ìŠ¤íŠ¸ ì—†ìŒ)'}
            </div>
        `;
        overlay.appendChild(suggestion);
        
        // ìˆ˜ë½ ë²„íŠ¼
        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'smart-label-accept-btn';
        acceptBtn.innerHTML = 'âœ“';
        acceptBtn.title = 'ì´ ë¼ë²¨ ì¶”ì²œ ìˆ˜ë½';
        acceptBtn.onclick = () => acceptSmartLabel(prediction, index);
        overlay.appendChild(acceptBtn);
        
        overlaysContainer.appendChild(overlay);
        
        // 30ì´ˆ í›„ ìë™ìœ¼ë¡œ ì˜¤ë²„ë ˆì´ ì œê±°
        setTimeout(() => {
            if (overlay && overlay.parentNode) {
                overlay.style.transition = 'opacity 0.5s';
                overlay.style.opacity = '0';
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.remove();
                    }
                }, 500);
            }
        }, 30000); // 30ì´ˆ
    });
}

// ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ ì˜¤ë²„ë ˆì´ ì œê±°
function clearSmartLabelOverlays() {
    const overlaysContainer = document.getElementById('bboxOverlays');
    if (!overlaysContainer) return;
    
    // smart-label-overlay í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œë§Œ ì œê±°
    const smartOverlays = overlaysContainer.querySelectorAll('.smart-label-overlay');
    smartOverlays.forEach(overlay => overlay.remove());
}

// ëª¨ë¸ í•™ìŠµ í•¨ìˆ˜
async function trainModel() {
    if (!confirm('í˜„ì¬ê¹Œì§€ ë¼ë²¨ë§ëœ ëª¨ë“  ë°ì´í„°ë¡œ ëª¨ë¸ì„ í•™ìŠµí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    // ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ
    showTrainingProgress();
    const startTime = Date.now();  // ì‹œì‘ ì‹œê°„ ê¸°ë¡
    
    try {
        // EventSourceë¥¼ ì‚¬ìš©í•˜ì—¬ SSE ìŠ¤íŠ¸ë¦¼ ì—°ê²°
        const eventSource = new EventSource('/api/train_model');
        let finalResult = null;
        let hasReceivedData = false;  // ë°ì´í„° ìˆ˜ì‹  ì—¬ë¶€ ì¶”ì 
        
        eventSource.onmessage = function(event) {
            hasReceivedData = true;  // ë°ì´í„° ìˆ˜ì‹  í™•ì¸
            try {
                const data = JSON.parse(event.data);
                console.log('Received training data:', data);
                
                if (data.progress !== undefined) {
                    // ì—ëŸ¬ ì²˜ë¦¬ (-1 ì§„í–‰ë¥ )
                    if (data.progress === -1) {
                        console.error('Training error:', data.error);
                        eventSource.close();
                        updateTrainingProgress(0, data.error || 'í•™ìŠµ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                        setTimeout(() => {
                            closeTrainingProgress();
                            showAlert(`ëª¨ë¸ í•™ìŠµ ì¤‘ ì˜¤ë¥˜: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                        }, 2000);
                        return;
                    }
                    
                    // ì •ìƒ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    let stage = 'data';
                    if (data.progress < 25) stage = 'data';
                    else if (data.progress < 70) stage = 'training';
                    else if (data.progress < 95) stage = 'validation';
                    else stage = 'complete';
                    
                    updateTrainingProgress(
                        data.progress,
                        data.message || 'í•™ìŠµ ì§„í–‰ ì¤‘...',
                        stage
                    );
                    
                    // ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
                    if (data.message && data.message.includes('íŒŒì¼ ì²˜ë¦¬')) {
                        updateTrainingDetails(`ì§„í–‰ ìƒí™©: ${data.message}`);
                    }
                } else if (data.status) {
                    // ìµœì¢… ê²°ê³¼
                    finalResult = data;
                }
            } catch (e) {
                console.error('ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
            }
        };
        
        eventSource.onerror = function(error) {
            console.log('EventSource error, readyState:', eventSource.readyState);
            
            // EventSource ìƒíƒœ í™•ì¸
            // 0 = CONNECTING, 1 = OPEN, 2 = CLOSED
            if (eventSource.readyState === EventSource.CLOSED) {
                console.log('EventSource connection closed');
                eventSource.close();
                
                // ìµœì†Œ ì‹¤í–‰ ì‹œê°„ í™•ì¸ (3ì´ˆ)
                const elapsedTime = Date.now() - startTime;
                const minDuration = 3000;
                
                // ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í•˜ê³  ë„ˆë¬´ ë¹¨ë¦¬ ì¢…ë£Œëœ ê²½ìš°
                if (!hasReceivedData && elapsedTime < minDuration) {
                    console.log('Connection closed too quickly without data - keeping modal open');
                    // ëª¨ë‹¬ì„ ìœ ì§€í•˜ê³  ì¬ì‹œë„ ë©”ì‹œì§€ í‘œì‹œ
                    updateTrainingProgress(0, 'ì„œë²„ ì—°ê²° ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                    setTimeout(() => {
                        closeTrainingProgress();
                        showAlert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                    }, 2000);
                    return;
                }
                
                if (finalResult && finalResult.status === 'success') {
                    updateTrainingProgress(100, 'í•™ìŠµ ì™„ë£Œ!', 'complete');
                    
                    // OCR í•™ìŠµ ê²°ê³¼ í‘œì‹œ
                    if (finalResult.ocr_learning && finalResult.ocr_learning.summary) {
                        const details = `
                            ì´ ìƒ˜í”Œ: ${finalResult.total_samples || 0}ê°œ<br>
                            ë¼ë²¨ í´ë˜ìŠ¤: ${finalResult.unique_labels || 0}ê°œ<br>
                            OCR ë³´ì •: ${finalResult.ocr_learning.summary.total_corrections || 0}ê°œ<br>
                            ì •í™•ë„: ${((finalResult.ocr_learning.current_accuracy || 0) * 100).toFixed(1)}%
                        `;
                        updateTrainingDetails(details);
                    }
                    
                    setTimeout(() => {
                        closeTrainingProgress();
                        showAlert(`ëª¨ë¸ í•™ìŠµ ì™„ë£Œ! ì´ ${finalResult.total_samples || 0}ê°œ ìƒ˜í”Œ, ${finalResult.unique_labels || 0}ê°œ ë¼ë²¨ í´ë˜ìŠ¤`, 'success');
                    }, 2000);
                } else if (eventSource.readyState === EventSource.CLOSED && !finalResult) {
                    // ì •ìƒ ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš° - í•™ìŠµì´ ì§„í–‰ë˜ì—ˆì„ ìˆ˜ ìˆìŒ
                    console.log('No final result received but connection closed - assuming completion');
                    updateTrainingProgress(100, 'í•™ìŠµ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ', 'complete');
                    setTimeout(() => {
                        closeTrainingProgress();
                        showAlert('ëª¨ë¸ í•™ìŠµ í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    }, 2000);
                }
            } else if (eventSource.readyState === EventSource.CONNECTING) {
                // ì¬ì—°ê²° ì‹œë„ ì¤‘ - ë¬´ì‹œ
                console.log('EventSource is reconnecting...');
            }
        };
        
    } catch (error) {
        console.error('ëª¨ë¸ í•™ìŠµ ì¤‘ ì˜¤ë¥˜:', error);
        closeTrainingProgress();
        showAlert(`ëª¨ë¸ í•™ìŠµ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
    }
}

// í•™ìŠµ ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ
function showTrainingProgress() {
    const modal = document.getElementById('trainingProgressModal');
    modal.style.display = 'block';
    updateTrainingProgress(0, 'í•™ìŠµ ì¤€ë¹„ ì¤‘...');
}

// í•™ìŠµ ì§„í–‰ë¥  ëª¨ë‹¬ ë‹«ê¸°
function closeTrainingProgress() {
    const modal = document.getElementById('trainingProgressModal');
    modal.style.display = 'none';
}

// ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
function updateTrainingProgress(percent, message, stage = 'data') {
    const progressBar = document.getElementById('trainingProgressBar');
    const progressText = document.getElementById('trainingProgressText');
    const progressMessage = document.getElementById('trainingProgressMessage');
    
    progressBar.style.width = `${percent}%`;
    progressText.textContent = `${Math.round(percent)}%`;
    progressMessage.textContent = message;
    
    // ë‹¨ê³„ë³„ ìƒ‰ìƒ ë³€ê²½
    progressBar.className = `progress-fill stage-${stage}`;
}

// ì§„í–‰ë¥  ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
function updateTrainingDetails(details) {
    const detailsDiv = document.getElementById('trainingProgressDetails');
    if (typeof details === 'object') {
        let html = '';
        for (const [key, value] of Object.entries(details)) {
            html += `<div><strong>${key}:</strong> ${value}</div>`;
        }
        detailsDiv.innerHTML = html;
    } else if (details.includes('<br>')) {
        // HTML í˜•ì‹ì¸ ê²½ìš°
        detailsDiv.innerHTML = details;
    } else {
        detailsDiv.textContent = details;
    }
}

// ëª¨ë¸ í†µê³„ í‘œì‹œ
async function showModelStats() {
    try {
        const response = await fetch('/api/model_stats');
        const stats = await response.json();
        
        if (response.ok) {
            let message = `
                <h3>ëª¨ë¸ í†µê³„</h3>
                <p>ì´ ìƒ˜í”Œ ìˆ˜: ${stats.total_samples || 0}</p>
                <p>ë¼ë²¨ í´ë˜ìŠ¤ ìˆ˜: ${stats.unique_labels || 0}</p>
                <p>ë§ˆì§€ë§‰ í•™ìŠµ: ${stats.last_training || 'N/A'}</p>
                <p>ëª¨ë¸ ì •í™•ë„: ${stats.accuracy ? (stats.accuracy * 100).toFixed(2) + '%' : 'N/A'}</p>
            `;
            showAlert(message, 'info');
        } else {
            showAlert('í†µê³„ ì¡°íšŒ ì‹¤íŒ¨', 'error');
        }
    } catch (error) {
        console.error('í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
        showAlert('í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ëª¨ë¸ ì´ˆê¸°í™” - labeling.jsì˜ resetModel í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì œê±°ë¨
// resetModel í•¨ìˆ˜ëŠ” labeling.jsì— ì •ì˜ë˜ì–´ ìˆìŒ

// ìŠ¤ë§ˆíŠ¸ ë¼ë²¨ ìˆ˜ë½
async function acceptSmartLabel(prediction, index) {
    try {
        // ìƒˆ bounding box ìƒì„±
        const newBox = {
            x: prediction.x,
            y: prediction.y,
            width: prediction.width,
            height: prediction.height,
            label: prediction.label_type,
            text: prediction.predicted_text || '',
            confidence: prediction.confidence,
            group_id: prediction.group_id || null
        };
        
        // labelingSystemì— ì¶”ê°€ (labeling.jsì˜ í•¨ìˆ˜ ì‚¬ìš©)
        if (window.labelingSystem && window.labelingSystem.addBoundingBoxFromData) {
            window.labelingSystem.addBoundingBoxFromData(newBox);
        } else {
            // ì§ì ‘ ì¶”ê°€
            addBoundingBoxAt(newBox.x, newBox.y, newBox.width, newBox.height, newBox.label, newBox.text);
        }
        
        // í•´ë‹¹ ì˜¤ë²„ë ˆì´ ì œê±°
        const overlay = document.getElementById(`smart-label-${index}`);
        if (overlay) {
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 300);
        }
        
        // ë°°ì—´ì—ì„œ ì œê±°
        smartLabelPredictions.splice(index, 1);
        
        // í•™ìŠµ ë°ì´í„°ë¡œ ì €ì¥
        await fetch('/api/accept_smart_label', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                filename: document.getElementById('labelingFilename').value,
                prediction: prediction,
                accepted: true
            })
        });
        
        showAlert('ë¼ë²¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        
    } catch (error) {
        console.error('Failed to accept smart label:', error);
        showAlert('ë¼ë²¨ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// Bounding box ì§ì ‘ ì¶”ê°€ (labeling.jsì— ì—†ì„ ê²½ìš° ëŒ€ë¹„)
function addBoundingBoxAt(x, y, width, height, label, text) {
    const overlaysContainer = document.getElementById('bboxOverlays');
    if (!overlaysContainer) return;
    
    const bbox = document.createElement('div');
    bbox.className = 'bbox-overlay';
    bbox.style.left = `${x}px`;
    bbox.style.top = `${y}px`;
    bbox.style.width = `${width}px`;
    bbox.style.height = `${height}px`;
    
    // ë¼ë²¨ í‘œì‹œ
    const labelDiv = document.createElement('div');
    labelDiv.className = 'bbox-label';
    labelDiv.textContent = label || 'Unknown';
    bbox.appendChild(labelDiv);
    
    // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤
    ['nw', 'ne', 'sw', 'se'].forEach(pos => {
        const handle = document.createElement('div');
        handle.className = `resize-handle ${pos}`;
        bbox.appendChild(handle);
    });
    
    overlaysContainer.appendChild(bbox);
    
    // ëª©ë¡ì— ì¶”ê°€
    updateBboxList();
}
</script>
{% endblock %}